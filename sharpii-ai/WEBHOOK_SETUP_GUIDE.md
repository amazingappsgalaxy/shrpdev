# üéØ Dodo Payments Webhook Setup Guide

## ‚úÖ API Integration Status

**GREAT NEWS!** Your new API key is working perfectly:

```json
{
  "success": true,
  "checkoutUrl": "https://test.checkout.dodopayments.com/w7yKlQFk",
  "paymentId": "pay_yDlcbt2habI4JDqLUGDRu"
}
```

## üîó Webhook Configuration

### Step 1: Your Public Webhook URL

**For localhost testing, use this URL:**
```
https://lovely-islands-matter.loca.lt/api/payments/webhook
```

> **Note**: This is a temporary public tunnel to your localhost:3002. The subdomain may change when you restart localtunnel.

### Step 2: Configure in Dodo Dashboard

1. **Go to your Dodo Payments Dashboard**
   - Navigate to `Settings > Webhooks`
   - Click `Add Webhook`

2. **Enter Webhook Details:**
   - **Endpoint URL**: `https://lovely-islands-matter.loca.lt/api/payments/webhook`
   - **Events to Subscribe**: Select these essential events:
     - `payment.succeeded` ‚úÖ
     - `payment.failed` ‚úÖ  
     - `subscription.created` ‚úÖ
     - `subscription.renewed` ‚úÖ
     - `subscription.cancelled` ‚úÖ

3. **Get Your Webhook Secret**
   - Copy the webhook secret key generated by Dodo
   - You'll need this for the next step

### Step 3: Update Environment Variables

Add the webhook secret to your `.env.local`:

```bash
# Add this line to .env.local
DODO_WEBHOOK_SECRET=your_webhook_secret_from_dodo_dashboard
```

## üß™ Testing Your Setup

### Test 1: Basic API Connection ‚úÖ
```bash
curl -X GET "http://localhost:3002/api/test-dodo"
# Result: ‚úÖ Working with new API key
```

### Test 2: Payment Creation ‚úÖ
```bash
curl -X POST "http://localhost:3002/api/payments/test-checkout" \
  -H "Content-Type: application/json" \
  -b cookies.txt \
  -d '{"plan": "test", "billingPeriod": "one-time"}'
# Result: ‚úÖ Creates payment link successfully
```

### Test 3: Webhook Reception (After Setup)
1. Make a test payment using the checkout URL
2. Check your server logs for webhook events
3. Verify webhook signature validation

## üîß Current Configuration

### API Key: ‚úÖ Working
```
API Key: s5SQQVaaXtx3_Awc.ijVTvrcJUFePnd04k1RBeB7tRQM_qbp0Rsx8fcTRn6RdnRRh
Product ID: pdt_mYcKtEdhWQVomTRUdfu0H (‚Çπ800 INR)
```

### Tunnel Status: ‚úÖ Active
```
Public URL: https://lovely-islands-matter.loca.lt
Local Port: 3002
Status: Running
```

## üì± Testing the Complete Flow

### Option A: Browser Testing
1. Visit: `http://localhost:3002/debug-payment`
2. Click "Create Demo Account"
3. Click "Test API Connection" (should show ‚úÖ)
4. Click "Test Basic Plan" (should create checkout URL)
5. Open the checkout URL in a new tab
6. Complete the test payment

### Option B: Command Line Testing
```bash
# Test the complete flow
cd /Users/dheer/Documents/sharpcode/sharpii-ai
./test-payment-flow.sh
```

## üö® Important Notes

### Webhook URL Changes
- The localtunnel URL (`lovely-islands-matter.loca.lt`) changes each time you restart
- For production, use a stable domain (e.g., your deployed app URL)
- Update the webhook URL in Dodo dashboard if the tunnel restarts

### Testing Mode
- Your current API key is in **test mode**
- Use test card numbers for payments
- No real money will be charged

### Webhook Events
When a payment is completed, you should see logs like:
```
POST /api/payments/webhook
webhook-signature: ...
webhook-id: ...
webhook-timestamp: ...
```

## üîÑ Webhook Event Handling

Your webhook endpoint `/api/payments/webhook` will handle these events:

```javascript
// Example webhook payload for payment.succeeded
{
  "business_id": "bus_VBHCJCKm2ndJcgMNAHPXC",
  "type": "payment.succeeded",
  "timestamp": "2025-09-03T12:00:00Z",
  "data": {
    "payload_type": "Payment",
    "payment_id": "pay_yDlcbt2habI4JDqLUGDRu",
    "amount": 800,
    "currency": "INR",
    "customer": {
      "email": "test@sharpii.ai",
      "name": "Test User"
    }
  }
}
```

## üéØ Next Steps

1. **Add webhook secret to environment** (after getting it from Dodo dashboard)
2. **Test a real payment** using the checkout URL
3. **Verify webhook reception** in your server logs
4. **Set up proper subscription products** for monthly/yearly billing

## üõ†Ô∏è Commands to Keep Running

Keep these terminals open while testing:

```bash
# Terminal 1: Next.js server
npm run dev

# Terminal 2: Public tunnel (if needed)
lt --port 3002
```

## ‚úÖ Success Checklist

- [x] API key working (`s5SQQVaaXtx3_Awc...`)
- [x] Payment creation working
- [x] Public tunnel active (`lovely-islands-matter.loca.lt`)
- [ ] Webhook URL configured in Dodo dashboard
- [ ] Webhook secret added to environment
- [ ] Test payment completed
- [ ] Webhook events received

**You're 90% done!** Just configure the webhook URL in your Dodo dashboard and you'll have a fully working payment system! üéâ