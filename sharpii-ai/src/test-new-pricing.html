<!DOCTYPE html>
<html>
<head>
    <title>Test New Pricing System</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #111;
            color: white;
        }
        .test-case {
            background: #222;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #0070f3;
        }
        .result {
            background: #333;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
        }
        button {
            background: #0070f3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0051a0; }
        .error { color: #ff6b6b; }
        .success { color: #51cf66; }
    </style>
</head>
<body>
    <h1>üß™ New Pricing System Test</h1>
    <p>Testing the ModelPricingEngine for RunningHub FLUX Upscaling</p>

    <div class="test-case">
        <h3>Test 1: Basic 1000x1000 Image</h3>
        <button onclick="testBasic()">Run Test</button>
        <div id="basic-result" class="result"></div>
    </div>

    <div class="test-case">
        <h3>Test 2: With MyUpscaler Enabled (+35%)</h3>
        <button onclick="testMyUpscaler()">Run Test</button>
        <div id="myupscaler-result" class="result"></div>
    </div>

    <div class="test-case">
        <h3>Test 3: High Steps (+2% each)</h3>
        <button onclick="testSteps()">Run Test</button>
        <div id="steps-result" class="result"></div>
    </div>

    <div class="test-case">
        <h3>Test 4: All Modifiers Combined</h3>
        <button onclick="testCombined()">Run Test</button>
        <div id="combined-result" class="result"></div>
    </div>

    <div class="test-case">
        <h3>Test 5: API Endpoint Test</h3>
        <button onclick="testAPI()">Test API</button>
        <div id="api-result" class="result"></div>
    </div>

    <script>
        function testBasic() {
            const settings = {
                imageWidth: 1000,
                imageHeight: 1000,
                steps: 10,
                enable_upscale: true,
                enable_myupscaler: false
            };

            fetch('/api/admin/model-pricing', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'calculate_preview',
                    modelId: 'runninghub-flux-upscaling',
                    data: {
                        width: 1000,
                        height: 1000,
                        settings: settings
                    }
                })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('basic-result').innerHTML =
                    data.success ?
                    `<span class="success">‚úÖ SUCCESS</span><br>
                     Credits: ${data.pricing.totalCredits}<br>
                     Resolution: ${data.pricing.resolutionTier.description}<br>
                     Breakdown: ${data.pricing.breakdown.join('<br>')}`
                    :
                    `<span class="error">‚ùå ERROR</span><br>${data.error}`;
            })
            .catch(error => {
                document.getElementById('basic-result').innerHTML =
                    `<span class="error">‚ùå FETCH ERROR</span><br>${error.message}`;
            });
        }

        function testMyUpscaler() {
            const settings = {
                imageWidth: 1000,
                imageHeight: 1000,
                steps: 10,
                enable_upscale: true,
                enable_myupscaler: true  // This should add 35%
            };

            fetch('/api/admin/model-pricing', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'calculate_preview',
                    modelId: 'runninghub-flux-upscaling',
                    data: {
                        width: 1000,
                        height: 1000,
                        settings: settings
                    }
                })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('myupscaler-result').innerHTML =
                    data.success ?
                    `<span class="success">‚úÖ SUCCESS</span><br>
                     Credits: ${data.pricing.totalCredits}<br>
                     Applied Increments: ${data.pricing.appliedIncrements.length}<br>
                     Breakdown: ${data.pricing.breakdown.join('<br>')}`
                    :
                    `<span class="error">‚ùå ERROR</span><br>${data.error}`;
            })
            .catch(error => {
                document.getElementById('myupscaler-result').innerHTML =
                    `<span class="error">‚ùå FETCH ERROR</span><br>${error.message}`;
            });
        }

        function testSteps() {
            const settings = {
                imageWidth: 1000,
                imageHeight: 1000,
                steps: 25,  // Should trigger +5% (steps 21-30)
                enable_upscale: true,
                enable_myupscaler: false
            };

            fetch('/api/admin/model-pricing', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'calculate_preview',
                    modelId: 'runninghub-flux-upscaling',
                    data: {
                        width: 1000,
                        height: 1000,
                        settings: settings
                    }
                })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('steps-result').innerHTML =
                    data.success ?
                    `<span class="success">‚úÖ SUCCESS</span><br>
                     Credits: ${data.pricing.totalCredits}<br>
                     Steps Modifier Applied: ${data.pricing.appliedIncrements.find(inc => inc.settingKey === 'steps') ? 'YES' : 'NO'}<br>
                     Breakdown: ${data.pricing.breakdown.join('<br>')}`
                    :
                    `<span class="error">‚ùå ERROR</span><br>${data.error}`;
            })
            .catch(error => {
                document.getElementById('steps-result').innerHTML =
                    `<span class="error">‚ùå FETCH ERROR</span><br>${error.message}`;
            });
        }

        function testCombined() {
            const settings = {
                imageWidth: 1000,
                imageHeight: 1000,
                steps: 35,              // +10% for steps > 30
                enable_upscale: true,
                enable_myupscaler: true, // +35%
                megapixels: 12.0,       // Should trigger increment
                guidance_scale: 12.0,   // +15% for guidance > 10
                denoise: 0.9           // +20% for denoise > 0.8
            };

            fetch('/api/admin/model-pricing', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'calculate_preview',
                    modelId: 'runninghub-flux-upscaling',
                    data: {
                        width: 1000,
                        height: 1000,
                        settings: settings
                    }
                })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('combined-result').innerHTML =
                    data.success ?
                    `<span class="success">‚úÖ SUCCESS</span><br>
                     Credits: ${data.pricing.totalCredits}<br>
                     Applied Increments: ${data.pricing.appliedIncrements.length}<br>
                     Increment Details:<br>${data.pricing.appliedIncrements.map(inc =>
                        `  ‚Ä¢ ${inc.settingName}: ${inc.addedCredits} credits (${inc.description})`
                     ).join('<br>')}<br>
                     Full Breakdown: ${data.pricing.breakdown.join('<br>')}`
                    :
                    `<span class="error">‚ùå ERROR</span><br>${data.error}`;
            })
            .catch(error => {
                document.getElementById('combined-result').innerHTML =
                    `<span class="error">‚ùå FETCH ERROR</span><br>${error.message}`;
            });
        }

        function testAPI() {
            const testPayload = {
                imageUrl: 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD//2Q==',  // Small test image
                settings: {
                    imageWidth: 1000,
                    imageHeight: 1000,
                    steps: 10,
                    enable_upscale: true,
                    enable_myupscaler: true,
                    prompt: 'high quality, detailed'
                },
                modelId: 'runninghub-flux-upscaling',
                imageId: 'test-pricing-' + Date.now(),
                userId: '11111111-1111-1111-1111-111111111111'
            };

            document.getElementById('api-result').innerHTML = 'Testing API endpoint...';

            fetch('/api/enhance-image', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(testPayload)
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('api-result').innerHTML =
                    `<span class="${data.success ? 'success' : 'error'}">${data.success ? '‚úÖ' : '‚ùå'}</span><br>
                     Response: ${JSON.stringify(data, null, 2)}`;
            })
            .catch(error => {
                document.getElementById('api-result').innerHTML =
                    `<span class="error">‚ùå API ERROR</span><br>${error.message}`;
            });
        }

        // Run basic test on load
        window.onload = function() {
            console.log('üß™ Pricing test page loaded. Ready to test the new pricing system!');
        }
    </script>
</body>
</html>